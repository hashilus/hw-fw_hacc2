# HACC2 - Hashilus Air Control Controller 2

## 概要
HACC2は、Hashilusの空気制御システムのコントローラーです。Mbed OSを使用して実装されており、UDP経由でコマンドを受け付け、SSRとRGB LEDを制御します。

## バージョン
- 現在のバージョン: 2.0.0
- 主な変更点:
  - ネットワーク接続の安定性向上
  - パケット処理の最適化
  - バッファサイズの拡大（8KB）
  - パフォーマンス監視機能の追加

## ハードウェア要件
- Mbed対応ボード
- イーサネットインターフェース
- SSRドライバー（4チャンネル）
- RGB LEDドライバー（3チャンネル）

## ソフトウェア要件
- Mbed OS 6.x
- コンパイラ: ARM GCC

## ビルド方法
```bash
mbed compile -m <TARGET> -t GCC_ARM
```

## 設定
### ネットワーク設定
- DHCP: デフォルトで有効
- 静的IP: 設定可能
- UDPポート: デフォルト5555

### デバッグレベル
- 0: エラーのみ
- 1: 基本情報
- 2: 詳細情報

## UDPコマンド仕様
### 基本形式
- コマンドはカンマ区切りの形式で送信
- 応答は`OK`または`ERROR`で終了
- エラー時は`コマンド名,ERROR`の形式で返信

### 基本コマンド
#### デバイス情報取得
- コマンド: `info`
- 応答: `info,<デバイス名>,2.0.0,OK`
- 例: `info` → `info,HACC2,2.0.0,OK`

### SSR制御
#### 出力制御
- コマンド: `set <id>,<value>`
  - id: 0-4 (0は全チャンネル)
  - value: 0-100 (0=OFF, 100=ON)
  - 応答: `set <id>,<value>,OK`
- エイリアス: `ssr <id>,<value>`
- 特殊値:
  - `ON`: 100%出力
  - `OFF`: 0%出力
- 例:
  - `set 1,50` → `set 1,50,OK` (チャンネル1を50%で制御)
  - `set 0,ON` → `set 0,100,OK` (全チャンネルを100%で制御)
  - `ssr 2,OFF` → `ssr 2,0,OK` (チャンネル2をOFF)

#### PWM周波数設定
- コマンド: `freq <id>,<value>`
  - id: 0-4 (0は全チャンネル)
  - value: 1-10 (Hz)
  - 応答: `freq <id>,<value>,OK`
- 例: `freq 0,5` → `freq 0,5,OK` (全チャンネルを5Hzに設定)

#### 状態取得
- コマンド: `get <id>`
  - id: 1-4
  - 応答: `get <id>,<duty>,<freq>,OK`
- 例: `get 1` → `get 1,50,5,OK` (チャンネル1の状態: デューティ比50%, 周波数5Hz)

### RGB LED制御
#### 色設定
- コマンド: `rgb <id>,<r>,<g>,<b>`
  - id: 0-3 (0は全LED)
  - r,g,b: 0-255
  - 応答: `rgb <id>,<r>,<g>,<b>,OK`
- 例:
  - `rgb 1,255,0,0` → `rgb 1,255,0,0,OK` (LED1を赤色に設定)
  - `rgb 0,0,255,0` → `rgb 0,0,255,0,OK` (全LEDを緑色に設定)

#### 状態取得
- コマンド: `rgbget <id>`
  - id: 1-3
  - 応答: `rgbget <id>,<r>,<g>,<b>,OK`
- 例: `rgbget 1` → `rgbget 1,255,0,0,OK` (LED1の現在の色: 赤)

### 特殊コマンド
#### ミスト制御
- コマンド: `mist <duration>`
  - duration: 0-10000 (ミリ秒)
  - 応答: `mist <duration>,OK`
- 動作: スプレーを指定時間噴射する
- 例: `mist 1000` → `mist 1000,OK` (1秒間ミストを制御)

#### エアー制御
- コマンド: `air <level>`
  - level: 0-2
    - 0: エアーOFF
    - 1: エアーLOW
    - 2: エアーHIGH
  - 応答: `air <level>,OK`
- 例: `air 2` → `air 2,OK` (エアーガンの出力をHIGHにする)

#### かわいいコマンド
- コマンド: `sofia`
- 応答: `sofia,KAWAII,OK` (ソフィアはかわいい、いいね？)

## パフォーマンス監視
- パケット処理時間の統計情報
  - 平均処理時間
  - 最大処理時間
  - 処理パケット数
- 100パケットごとに統計情報を表示
- 処理時間が100msを超える場合に警告を表示

## エラー処理
- ネットワーク切断時の自動再接続
- ソケットエラー時の自動再初期化
- パケット処理時間の監視と警告
- エラー発生時のログ出力
  - レベル0: エラーのみ
  - レベル1: 基本情報
  - レベル2: 詳細情報

## ライセンス
- プロプライエタリ

## 作者
- Hashilus 

## シリアルコンソール
### 接続方法
- ボーレート: 115200 bps
- データビット: 8
- パリティ: なし
- ストップビット: 1
- フロー制御: なし

### コマンド一覧
#### 基本コマンド
- `help`: ヘルプを表示
- `info`: デバイス情報を表示
- `reboot`: デバイスを再起動
- `debug level <0-3>`: デバッグレベルを設定
- `debug status`: 現在のデバッグレベルを表示

#### SSR制御
- `set <id> <value>`: SSRの出力を設定
  - id: 1-4
  - value: 0-100 (0=OFF, 100=ON)
  - 例: `set 1 50` (チャンネル1を50%で制御)
- `freq <id> <value>`: PWM周波数を設定
  - id: 1-4
  - value: 1-10 (Hz)
  - 例: `freq 1 5` (チャンネル1を5Hzに設定)
- `get <id>`: SSRの状態を取得
  - id: 1-4
  - 例: `get 1` (チャンネル1の状態を表示)

#### RGB LED制御
- `rgb <id> <r> <g> <b>`: RGB LEDの色を設定
  - id: 1-3
  - r,g,b: 0-255
  - 例: `rgb 1 255 0 0` (LED1を赤色に設定)
- `rgbget <id>`: RGB LEDの状態を取得
  - id: 1-3
  - 例: `rgbget 1` (LED1の現在の色を表示)

#### 設定コマンド
- `config`: 現在の設定を表示
- `config save`: 設定を保存
- `config load`: 設定を読み込み
- `config ssrlink on/off`: SSR-LED連動の有効/無効
- `netbios <name>`: NETBIOS名を設定
- `ip <address>`: IPアドレスを設定
- `mask <netmask>`: サブネットマスクを設定
- `gateway <address>`: デフォルトゲートウェイを設定
- `dhcp on/off`: DHCPの有効/無効

### コマンド入力機能
- コマンド履歴: 上下矢印キーで履歴を参照
- カーソル移動: 左右矢印キーでカーソルを移動
- バックスペース: 文字を削除
- タブ補完: サポート予定

### 応答形式
- 成功時: コマンドの実行結果を表示
- エラー時: エラーメッセージを表示
- デバッグ情報: デバッグレベルに応じて詳細情報を表示 